<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang chủ - MoneyFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 100vh;
            /*padding-top: 70px;*/
        }
        .navbar {
            display: block !important;
            position: fixed !important;
            top: 0 !important;
            z-index: 1000 !important;
        }
        .navbar-brand { font-weight: bold; }
        .nav-link { color: #bbb !important; transition: color .3s; }
        .nav-link.active, .nav-link:hover { color: #fff !important; }
        .section-card {
            min-height: 150px;
        }
        .chart-container {
            aspect-ratio: 1 / 1; /* Giữ tỷ lệ vuông */
            max-height: 100%;
            width: 100%;
        }
        .line-height-5 {
            line-height: 1.25rem; /* ~20px, phù hợp với text-lg (16px) */
        }
    </style>
</head>
<body>
<div th:replace="fragments/navbar :: main-navbar"></div>

<main class="container mx-auto p-6 pt-24 space-y-6">
    <section class="bg-white rounded-2xl shadow-lg p-4 section-card animate__animated animate__fadeInUp">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-xl font-bold text-indigo-600 text-center">Chatbot MoneyFlow</h2>
            <button id="darkToggle" class="p-2 bg-gray-200 rounded-full hover:bg-gray-300 transition"></button>
        </div>
        <div id="chatbot-messages" class="h-48 overflow-y-auto p-3 bg-gray-50 rounded-lg border border-gray-200 animate__animated animate__fadeIn"></div>
        <div class="mt-3 flex space-x-2">
            <input id="chatbot-input" type="text" placeholder="VD: Hôm nay đổ xăng 30k ví mbbank" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-400" />
            <button onclick="sendMessage()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-4 rounded-lg transition animate__animated animate__pulse animate__infinite">Gửi</button>
        </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <aside class="lg:col-span-1 animate__animated animate__fadeInLeft">
            <div class="bg-white rounded-2xl shadow-lg p-4 section-card">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">Giao dịch gần đây</h3>
                <div th:if="${#lists.isEmpty(recentTransactions)}" class="text-center text-gray-500">
                    <p>Bạn chưa có giao dịch nào gần đây. Hãy <a th:href="@{/transactions/new}" class="text-indigo-600 underline">thêm giao dịch mới</a>!</p>
                </div>
                <ul th:unless="${#lists.isEmpty(recentTransactions)}" class="space-y-3">
                    <li th:each="transaction : ${recentTransactions}" class="p-3 bg-gray-50 rounded-xl hover:bg-indigo-50 transition shadow-sm">
                        <div class="flex justify-between items-center mb-1">
                            <h5 class="text-base font-medium text-gray-800" th:text="${transaction.description ?: transaction.category.name}"></h5>
                            <span class="text-sm text-gray-500" th:text="${#temporals.format(transaction.transactionDate, 'dd/MM/yyyy HH:mm')}"></span>
                        </div>
                        <div class="text-sm text-gray-700 mb-1">
                            Số tiền:
                            <strong th:classappend="${transaction.type.name() == 'INCOME' ? 'text-success' : 'text-danger'}"
                                    th:text="${(transaction.type.name() == 'INCOME' ? '+' : '-') + numberFormatter.formatBigDecimal(transaction.amount) + ' ' + transaction.account.currency}">
                            </strong>
                        </div>
                        <div class="text-sm text-gray-500">
                            Ví: <span th:text="${transaction.account.name}"></span> |
                            Danh mục: <span th:text="${transaction.category.name}"></span>
                        </div>
                        <div class="text-end space-x-2 mt-1">
                            <a th:href="@{/transactions/edit/{id}(id=${transaction.id})}" class="btn btn-sm btn-outline-primary">Sửa</a>
                            <form th:action="@{/transactions/delete/{id}(id=${transaction.id})}" method="post" class="d-inline">
                                <input type="hidden" name="_method" value="delete" />
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Bạn có chắc chắn muốn xóa giao dịch này?');">Xóa</button>
                            </form>
                        </div>
                    </li>
                </ul>
            </div>
        </aside>

        <section class="lg:col-span-3 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 animate__animated animate__fadeInUp">
                <div class="bg-green-100 p-3 rounded-2xl shadow-lg text-center section-card"><h4 class="text-sm font-medium text-green-700">Tổng thu nhập</h4><p class="mt-1 text-lg font-bold text-green-800" th:text="${numberFormatter.formatBigDecimal(totalIncome)+' VND'}"></p></div>
                <div class="bg-red-100 p-3 rounded-2xl shadow-lg text-center section-card"><h4 class="text-sm font-medium text-red-700">Tổng chi tiêu</h4><p class="mt-1 text-lg font-bold text-red-800" th:text="${numberFormatter.formatBigDecimal(totalExpense)+' VND'}"></p></div>
                <div class="bg-blue-100 p-3 rounded-2xl shadow-lg text-center section-card"><h4 class="text-sm font-medium text-blue-700">Số dư</h4><p class="mt-1 text-lg font-bold text-blue-800" th:text="${numberFormatter.formatBigDecimal(totalBalance)+' VND'}"></p></div>
            </div>
            <div class="bg-white rounded-2xl shadow-lg p-4 section-card animate__animated animate__fadeInUp flex">
                <div class="w-1/2 pr-2">
                    <h4 class="text-base font-semibold text-gray-700 mb-3 text-center">Xu hướng chi tiêu 7 ngày</h4>
                    <div class="chart-container">
                        <canvas id="expenseChart" class="w-full h-48"></canvas>
                    </div>
                </div>
                <div class="w-1/2 pl-2">
                    <h4 class="text-base font-semibold text-gray-700 mb-3 text-center">Chi tiêu theo danh mục</h4>
                    <div class="chart-container">
                        <canvas id="categoryExpenseChart" class="w-full h-48"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<footer class="text-center py-4 text-gray-600">© 2025 MoneyFlow</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    document.getElementById('darkToggle').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Biểu đồ xu hướng chi tiêu 7 ngày
        var ctx = document.getElementById('expenseChart');
        if (ctx) {
            var chartLabelsRaw = /*[[${chartLabels}]]*/ '';
            var chartDataRaw = /*[[${chartData}]]*/ '';
            var labels = chartLabelsRaw ? chartLabelsRaw.split(',').map(l => l.trim().split('-').reverse().join('/')) : [];
            var data = chartDataRaw ? chartDataRaw.split(',').map(v => parseFloat(v.trim()) || 0) : [];
            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Chi tiêu (VND)',
                        data: data,
                        backgroundColor: 'rgba(237,100,166,0.2)',
                        borderColor: '#ED64A6',
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: v => v.toLocaleString('vi-VN') + ' VND'
                            }
                        }
                    }
                }
            });
        }

        // Biểu đồ chi tiêu theo danh mục
        var categoryCtx = document.getElementById('categoryExpenseChart');
        if (categoryCtx) {
            fetch('/transactions/api/expenses-by-category')
                .then(res => res.json())
                .then(data => {
                    var labels = data.map(item => item.categoryName);
                    var amounts = data.map(item => parseFloat(item.totalAmount));
                    new Chart(categoryCtx.getContext('2d'), {
                        type: 'pie',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Chi tiêu theo danh mục (VND)',
                                data: amounts,
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.6)',
                                    'rgba(54, 162, 235, 0.6)',
                                    'rgba(255, 206, 86, 0.6)',
                                    'rgba(75, 192, 192, 0.6)',
                                    'rgba(153, 102, 255, 0.6)',
                                    'rgba(255, 159, 64, 0.6)'
                                ],
                                borderColor: [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(153, 102, 255, 1)',
                                    'rgba(255, 159, 64, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            let value = context.raw || 0;
                                            return `${label}: ${value.toLocaleString('vi-VN')} VND`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                });
        }
    });

    function sendMessage() {
        var input = document.getElementById('chatbot-input');
        var msg = input.value.trim();
        if (!msg) return;
        var box = document.getElementById('chatbot-messages');
        box.innerHTML += '<p class="animate__animated animate__fadeIn">👤 ' + msg + '</p>';
        input.value = '';
        fetch('/api/chatbot', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({message: msg})
        })
            .then(res => res.text())
            .then(text => {
                box.innerHTML += '<p class="animate__animated animate__fadeIn">🤖 ' + text + '</p>';
                box.scrollTop = box.scrollHeight;
            });
    }

    document.getElementById('chatbot-input')
        .addEventListener('keydown', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
</script>
</body>
</html>