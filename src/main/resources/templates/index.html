<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang ch·ªß - MoneyFlow</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            min-height: 100vh;
            padding-top: 70px;
        }
        .navbar {
            display: block !important;
            position: fixed !important;
            top: 0 !important;
            z-index: 1000 !important;
        }
        .navbar-brand { font-weight: bold; }
        .nav-link { color: #bbb !important; transition: color .3s; }
        .nav-link.active, .nav-link:hover { color: #fff !important; }
    </style>
</head>
<body>
<div th:replace="fragments/navbar :: main-navbar"></div>

<main class="container mx-auto p-6 pt-24 space-y-8">
    <section class="bg-white rounded-2xl shadow-lg p-6 animate__animated animate__fadeInUp">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-indigo-600">Chatbot MoneyFlow</h2>
            <button id="darkToggle" class="p-2 bg-gray-200 rounded-full hover:bg-gray-300 transition"><span>üåô</span></button>
        </div>
        <div id="chatbot-messages" class="h-64 overflow-y-auto p-4 bg-gray-50 rounded-lg border border-gray-200 animate__animated animate__fadeIn"></div>
        <div class="mt-4 flex space-x-3">
            <input id="chatbot-input" type="text" placeholder="VD: H√¥m nay ƒë·ªï xƒÉng 30k v√≠ mbbank" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-400" />
            <button onclick="sendMessage()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-6 rounded-lg transition animate__animated animate__pulse animate__infinite">G·ª≠i</button>
        </div>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <aside class="lg:col-span-1 animate__animated animate__fadeInLeft">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Giao d·ªãch g·∫ßn ƒë√¢y</h3>

                <div th:if="${#lists.isEmpty(recentTransactions)}" class="text-center text-gray-500">
                    <p>B·∫°n ch∆∞a c√≥ giao d·ªãch n√†o g·∫ßn ƒë√¢y. H√£y <a th:href="@{/transactions/new}" class="text-indigo-600 underline">th√™m giao d·ªãch m·ªõi</a>!</p>
                </div>

                <ul th:unless="${#lists.isEmpty(recentTransactions)}" class="space-y-4">
                    <li th:each="transaction : ${recentTransactions}" class="p-4 bg-gray-50 rounded-xl hover:bg-indigo-50 transition shadow-sm">
                        <div class="flex justify-between items-center mb-1">
                            <h5 class="text-base font-medium text-gray-800" th:text="${transaction.description ?: transaction.category.name}"></h5>
                            <span class="text-sm text-gray-500" th:text="${#temporals.format(transaction.transactionDate, 'dd/MM/yyyy HH:mm')}"></span>
                        </div>
                        <div class="text-sm text-gray-700 mb-1">
                            S·ªë ti·ªÅn:
                            <strong th:classappend="${transaction.type.name() == 'INCOME' ? 'text-success' : 'text-danger'}"
                                    th:text="${(transaction.type.name() == 'INCOME' ? '+' : '-') + numberFormatter.formatBigDecimal(transaction.amount) + ' ' + transaction.account.currency}">
                            </strong>
                        </div>
                        <div class="text-sm text-gray-500 mb-2">
                            V√≠: <span th:text="${transaction.account.name}"></span> |
                            Danh m·ª•c: <span th:text="${transaction.category.name}"></span>
                        </div>
                        <div class="text-end space-x-2">
                            <a th:href="@{/transactions/edit/{id}(id=${transaction.id})}" class="btn btn-sm btn-outline-primary">S·ª≠a</a>
                            <form th:action="@{/transactions/delete/{id}(id=${transaction.id})}" method="post" class="d-inline">
                                <input type="hidden" name="_method" value="delete" />
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y?');">X√≥a</button>
                            </form>
                        </div>
                    </li>
                </ul>
            </div>
        </aside>

        <section class="lg:col-span-3 space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 animate__animated animate__fadeInUp">
                <div class="bg-green-100 p-6 rounded-2xl shadow-lg"><h4 class="text-sm font-medium text-green-700">T·ªïng thu nh·∫≠p</h4><p class="mt-2 text-2xl font-bold text-green-800" th:text="${numberFormatter.formatBigDecimal(totalIncome)+' VND'}"></p></div>
                <div class="bg-red-100 p-6 rounded-2xl shadow-lg"><h4 class="text-sm font-medium text-red-700">T·ªïng chi ti√™u</h4><p class="mt-2 text-2xl font-bold text-red-800" th:text="${numberFormatter.formatBigDecimal(totalExpense)+' VND'}"></p></div>
                <div class="bg-blue-100 p-6 rounded-2xl shadow-lg"><h4 class="text-sm font-medium text-blue-700">S·ªë d∆∞</h4><p class="mt-2 text-2xl font-bold text-blue-800" th:text="${numberFormatter.formatBigDecimal(totalBalance)+' VND'}"></p></div>
            </div>
            <div class="bg-white rounded-2xl shadow-lg p-6 animate__animated animate__fadeInUp">
                <h4 class="text-lg font-semibold text-gray-700 mb-4">Xu h∆∞·ªõng chi ti√™u 7 ng√†y</h4>
                <canvas id="expenseChart" class="w-full h-64"></canvas>
            </div>
        </section>
    </div>
</main>

<footer class="text-center py-4 text-gray-600">¬© 2025 MoneyFlow</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    document.getElementById('darkToggle').addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
    });

    document.addEventListener('DOMContentLoaded', function() {
        var ctx = document.getElementById('expenseChart');
        if (!ctx) return;
        var chartLabelsRaw = /*[[${chartLabels}]]*/ '';
        var chartDataRaw = /*[[${chartData}]]*/ '';
        var labels = chartLabelsRaw ? chartLabelsRaw.split(',').map(l => l.trim().split('-').reverse().join('/')) : [];
        var data = chartDataRaw ? chartDataRaw.split(',').map(v => parseFloat(v.trim()) || 0) : [];
        new Chart(ctx.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Chi ti√™u (VND)',
                    data: data,
                    backgroundColor: 'rgba(237,100,166,0.2)',
                    borderColor: '#ED64A6',
                    borderWidth: 3,
                    tension: 0.3,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: v => v.toLocaleString('vi-VN') + ' VND'
                        }
                    }
                }
            }
        });
    });

    function sendMessage() {
        var input = document.getElementById('chatbot-input');
        var msg = input.value.trim();
        if (!msg) return;
        var box = document.getElementById('chatbot-messages');
        box.innerHTML += '<p class="animate__animated animate__fadeIn">üë§ ' + msg + '</p>';
        input.value = '';
        fetch('/api/chatbot', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({message: msg})
        })
            .then(res => res.text())
            .then(text => {
                box.innerHTML += '<p class="animate__animated animate__fadeIn">ü§ñ ' + text + '</p>';
                box.scrollTop = box.scrollHeight;
            });
    }

    document.getElementById('chatbot-input')
        .addEventListener('keydown', function(e) {
            if (e.key === 'Enter') sendMessage();
        });
</script>
</body>
</html>